"use strict";var ue=Object.defineProperty,he=Object.defineProperties,pe=Object.getOwnPropertyDescriptors,B=Object.getOwnPropertySymbols,fe=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable,J=(x,m,h)=>m in x?ue(x,m,{enumerable:!0,configurable:!0,writable:!0,value:h}):x[m]=h,R=(x,m)=>{for(var h in m||(m={}))fe.call(m,h)&&J(x,h,m[h]);if(B)for(var h of B(m))de.call(m,h)&&J(x,h,m[h]);return x},$=(x,m)=>he(x,pe(m));(self.webpackChunkangular_anb=self.webpackChunkangular_anb||[]).push([[1991],{1991:(x,m,h)=>{h.r(m),h.d(m,{ElevationQuery:()=>j,GeometryDescriptor:()=>g,default:()=>j,getFinestLodIndex:()=>F});var f=h(15861),K=h(59213),T=h(26584),y=h(62208),Z=h(10699),D=h(16730),C=h(72854),q=h(49672),X=h(55214),A=h(56741),w=h(65401),Y=(h(29132),h(8314),h(63290)),ee=h(33190),te=h(46367);const M=Y.Z.getLogger("esri.layers.support.ElevationSampler");class L{queryElevation(e){return function ie(c,e){const t=P(c,e.spatialReference);if(!t)return null;switch(c.type){case"point":!function se(c,e,t){c.z=(0,y.Pt)(t.elevationAt(e),0)}(c,t,e);break;case"polyline":!function le(c,e,t){E.spatialReference=e.spatialReference;const n=c.hasM&&!c.hasZ;for(let i=0;i<c.paths.length;i++){const l=c.paths[i],s=e.paths[i];for(let a=0;a<l.length;a++){const o=l[a],r=s[a];E.x=r[0],E.y=r[1],n&&(o[3]=o[2]),o[2]=(0,y.Pt)(t.elevationAt(E),0)}}c.hasZ=!0}(c,t,e);break;case"multipoint":!function oe(c,e,t){E.spatialReference=e.spatialReference;const n=c.hasM&&!c.hasZ;for(let i=0;i<c.points.length;i++){const l=c.points[i],s=e.points[i];E.x=s[0],E.y=s[1],n&&(l[3]=l[2]),l[2]=(0,y.Pt)(t.elevationAt(E),0)}c.hasZ=!0}(c,t,e)}return c}(e.clone(),this)}on(){return ae}projectIfRequired(e,t){return P(e,t)}}class ne extends L{constructor(e,t,n){super(),this.tile=e,this.noDataValue=n,this.extent=(0,w.HH)(e.tile.extent,t.spatialReference);const i=(0,D.c9)(t.spatialReference),l=t.lodAt(e.tile.level).resolution*i;this.demResolution={min:l,max:l}}get spatialReference(){return this.extent.spatialReference}contains(e){const t=this.projectIfRequired(e,this.spatialReference);return(0,ee.aV)(this.extent,t)}elevationAt(e){const t=this.projectIfRequired(e,this.spatialReference);if((0,y.Wi)(t))return null;if(!this.contains(e)){const n=this.extent;return M.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler extent (${n.xmin}, ${n.ymin}, ${n.xmax}, ${n.ymax})`),this.noDataValue}return this.tile.sample(t.x,t.y)}}class O extends L{constructor(e,t,n){let i;super(),"number"==typeof t?(this.noDataValue=t,i=null):(i=t,this.noDataValue=n),this.samplers=i?e.map(s=>new ne(s,i,this.noDataValue)):e;const l=this.samplers[0];if(l){this.extent=l.extent.clone();const{min:s,max:a}=l.demResolution;this.demResolution={min:s,max:a};for(let o=1;o<this.samplers.length;o++){const r=this.samplers[o];this.extent.union(r.extent),this.demResolution.min=Math.min(this.demResolution.min,r.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,r.demResolution.max)}}else this.extent=(0,w.HH)((0,w.Ue)(),i.spatialReference),this.demResolution={min:0,max:0}}get spatialReference(){return this.extent.spatialReference}elevationAt(e){const t=this.projectIfRequired(e,this.spatialReference);if(!t)return null;for(const n of this.samplers)if(n.contains(t))return n.elevationAt(t);return M.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler`),this.noDataValue}}function P(c,e){if((0,y.Wi)(c))return null;const t=c.spatialReference;if(t.equals(e))return c;const n=(0,te.iV)(c,e);return n||M.error(`Cannot project geometry spatial reference (wkid:${t.wkid}) to elevation sampler spatial reference (wkid:${e.wkid})`),n}const E=new q.Z,ae={remove(){}};class U{constructor(e,t=null){if(this.tile=e,(0,y.pC)(t)){const n=e.extent;this.samplerData={pixelData:t.values,width:t.width,height:t.height,safeWidth:.99999999*(t.width-1),noDataValue:t.noDataValue,dx:(t.width-1)/(n[2]-n[0]),dy:(t.width-1)/(n[3]-n[1]),x0:n[0],y1:n[3]}}}sample(e,t){if((0,y.Wi)(this.samplerData))return;const{safeWidth:n,width:i,pixelData:l,noDataValue:s,dx:a,dy:o,y1:r,x0:u}=this.samplerData,p=W(o*(r-t),0,n),d=W(a*(e-u),0,n),v=Math.floor(p),b=Math.floor(d),z=v*i+b,H=z+i,V=l[z],S=l[H],Q=l[z+1],k=l[H+1];if(V!==s&&S!==s&&Q!==s&&k!==s){const N=d-b,_=V+(Q-V)*N;return _+(S+(k-S)*N-_)*(p-v)}}}function W(c,e,t){return c<e?e:c>t?t:c}class j{queryAll(e,t,n){var i=this;return(0,f.Z)(function*(){if(!(e=n&&n.ignoreInvisibleLayers?e.filter(u=>u.visible):e.slice()).length)throw new T.Z("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");const l=g.fromGeometry(t);let s=!1;n&&n.returnSampleInfo||(s=!0);const a=$(R(R({},I),n),{returnSampleInfo:!0}),o=yield i.query(e[e.length-1],l,a),r=yield i._queryAllContinue(e,o,a);return r.geometry=r.geometry.export(),s&&delete r.sampleInfo,r})()}query(e,t,n){var i=this;return(0,f.Z)(function*(){if(!e)throw new T.Z("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||!(t instanceof g)&&"point"!==t.type&&"multipoint"!==t.type&&"polyline"!==t.type)throw new T.Z("elevation-query:invalid-geometry","Only point, polyline and multipoint geometries can be used to query elevation");const l=R(R({},I),n),s=new re(e,t.spatialReference,l),a=l.signal;return yield e.load({signal:a}),yield i._createGeometryDescriptor(s,t,a),yield i._selectTiles(s,a),yield i._populateElevationTiles(s,a),i._sampleGeometryWithElevation(s),i._createQueryResult(s,a)})()}createSampler(e,t,n){var i=this;return(0,f.Z)(function*(){if(!e)throw new T.Z("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new T.Z("elevation-query:invalid-extent","Invalid or undefined extent");const l=R(R({},I),n);return i._createSampler(e,t,l)})()}createSamplerAll(e,t,n){var i=this;return(0,f.Z)(function*(){if(!(e=n&&n.ignoreInvisibleLayers?e.filter(a=>a.visible):e.slice()).length)throw new T.Z("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new T.Z("elevation-query:invalid-extent","Invalid or undefined extent");const l=$(R(R({},I),n),{returnSampleInfo:!0}),s=yield i._createSampler(e[e.length-1],t,l);return i._createSamplerAllContinue(e,t,s,l)})()}_createSampler(e,t,n,i){var l=this;return(0,f.Z)(function*(){const s=n.signal;yield e.load({signal:s});const a=t.spatialReference,o=e.tileInfo.spatialReference;a.equals(o)||(yield(0,A.iQ)([{source:a,dest:o}],{signal:s}),t=(0,A.iV)(t,o));const r=new ce(e,t,n,i);return yield l._selectTiles(r,s),yield l._populateElevationTiles(r,s),new O(r.elevationTiles,r.layer.tileInfo,r.options.noDataValue)})()}_createSamplerAllContinue(e,t,n,i){var l=this;return(0,f.Z)(function*(){if(e.pop(),!e.length)return n;const s=n.samplers.map(u=>(0,w.oJ)(u.extent)),a=yield l._createSampler(e[e.length-1],t,i,s);if(0===a.samplers.length)return n;const o=n.samplers.concat(a.samplers),r=new O(o,i.noDataValue);return l._createSamplerAllContinue(e,t,r,i)})()}_queryAllContinue(e,t,n){var i=this;return(0,f.Z)(function*(){const l=e.pop(),s=t.geometry.coordinates,a=[],o=[];for(let p=0;p<s.length;p++){const d=t.sampleInfo[p];d.demResolution>=0?d.source||(d.source=l):e.length&&(a.push(s[p]),o.push(p))}if(!e.length||0===a.length)return t;const r=t.geometry.clone(a),u=yield i.query(e[e.length-1],r,n);return o.forEach((p,d)=>{s[p].z=u.geometry.coordinates[d].z,t.sampleInfo[p].demResolution=u.sampleInfo[d].demResolution}),i._queryAllContinue(e,t,n)})()}_createQueryResult(e,t){var n=this;return(0,f.Z)(function*(){const i={geometry:(yield e.geometry.project(e.outSpatialReference,t)).export(),noDataValue:e.options.noDataValue};return e.options.returnSampleInfo&&(i.sampleInfo=n._extractSampleInfo(e)),e.geometry.coordinates.forEach(l=>{l.tile=null,l.elevationTile=null}),i})()}_createGeometryDescriptor(e,t,n){return(0,f.Z)(function*(){let i;const l=e.layer.tileInfo.spatialReference;if(t instanceof g?i=yield t.project(l,n):(yield(0,A.iQ)([{source:t.spatialReference,dest:l}],{signal:n}),i=(0,A.iV)(t,l)),!i)throw new T.Z("elevation-query:spatial-reference-mismatch",`Cannot query elevation in '${t.spatialReference.wkid}' on an elevation service in '${l.wkid}'`);e.geometry=g.fromGeometry(i)})()}_selectTiles(e,t){var n=this;return(0,f.Z)(function*(){const i=e.options.demResolution;if("geometry"===e.type&&n._preselectOutsideLayerExtent(e),"number"==typeof i)n._selectTilesClosestResolution(e);else if("finest-contiguous"===i)yield n._selectTilesFinestContiguous(e,t);else{if("auto"!==i)throw new T.Z("elevation-query:invalid-dem-resolution",`Invalid dem resolution value '${i}', expected a number, "finest-contiguous" or "auto"`);yield n._selectTilesAuto(e,t)}})()}_preselectOutsideLayerExtent(e){if((0,y.Wi)(e.layer.fullExtent))return;const t=new U(null);t.sample=()=>e.options.noDataValue,e.outsideExtentTile=t;const n=e.layer.fullExtent;e.geometry.coordinates.forEach(i=>{const l=i.x,s=i.y;(l<n.xmin||l>n.xmax||s<n.ymin||s>n.ymax)&&(i.elevationTile=t)})}_selectTilesClosestResolution(e){const n=this._findNearestDemResolutionLODIndex(e.layer.tileInfo,e.options.demResolution);e.selectTilesAtLOD(n)}_findNearestDemResolutionLODIndex(e,t){const n=t/(0,D.c9)(e.spatialReference);let i=e.lods[0],l=0;for(let s=1;s<e.lods.length;s++){const a=e.lods[s];Math.abs(a.resolution-n)<Math.abs(i.resolution-n)&&(i=a,l=s)}return l}_selectTilesFinestContiguous(e,t){var n=this;return(0,f.Z)(function*(){const i=F(e.layer.tileInfo,e.options.minDemResolution);yield n._selectTilesFinestContiguousAt(e,i,t)})()}_selectTilesFinestContiguousAt(e,t,n){var i=this;return(0,f.Z)(function*(){const l=e.layer;if(e.selectTilesAtLOD(t),t<0)return;const s=l.tilemapCache,a=e.getTilesToFetch();try{if(s)yield(0,Z.Hl)(Promise.all(a.map(o=>s.fetchAvailability(o.level,o.row,o.col,{signal:n}))),n);else if(yield i._populateElevationTiles(e,n),!e.allElevationTilesFetched())throw e.clearElevationTiles(),new T.Z("elevation-query:has-unavailable-tiles")}catch(o){(0,Z.r9)(o),yield i._selectTilesFinestContiguousAt(e,t-1,n)}})()}_populateElevationTiles(e,t){return(0,f.Z)(function*(){const n=e.getTilesToFetch(),i={},l=e.options.cache,s=e.options.noDataValue,a=n.map(function(){var o=(0,f.Z)(function*(r){const u=`${e.layer.uid}:${r.id}:${s}`,p=(0,y.pC)(l)?l.get(u):null,d=(0,y.pC)(p)?p:yield e.layer.fetchTile(r.level,r.row,r.col,{noDataValue:s,signal:t});(0,y.pC)(l)&&l.put(u,d),i[r.id]=new U(r,d)});return function(r){return o.apply(this,arguments)}}());yield(0,Z.Hl)((0,Z.as)(a),t),e.populateElevationTiles(i)})()}_selectTilesAuto(e,t){var n=this;return(0,f.Z)(function*(){n._selectTilesAutoFinest(e),n._reduceTilesForMaximumRequests(e);const i=e.layer.tilemapCache;if(!i)return n._selectTilesAutoPrefetchUpsample(e,t);const l=e.getTilesToFetch(),s={},a=l.map(function(){var o=(0,f.Z)(function*(r){const u={id:null,level:0,row:0,col:0,extent:(0,w.Ue)()},p=yield(0,K.q6)(i.fetchAvailabilityUpsample(r.level,r.row,r.col,u,{signal:t}));!1===p.ok?(0,Z.r9)(p.error):s[r.id]=u});return function(r){return o.apply(this,arguments)}}());yield(0,Z.Hl)(Promise.all(a),t),e.remapTiles(s)})()}_reduceTilesForMaximumRequests(e){const t=e.layer.tileInfo;let n=0;const i={},l=o=>{o.id in i?i[o.id]++:(i[o.id]=1,n++)},s=o=>{const r=i[o.id];1===r?(delete i[o.id],n--):i[o.id]=r-1};e.forEachTileToFetch(l,s);let a=!0;for(;a&&(a=!1,e.forEachTileToFetch(o=>{n<=e.options.maximumAutoTileRequests||(s(o),t.upsampleTile(o)&&(a=!0),l(o))},s),a););}_selectTilesAutoFinest(e){const t=F(e.layer.tileInfo,e.options.minDemResolution);e.selectTilesAtLOD(t,e.options.maximumAutoTileRequests)}_selectTilesAutoPrefetchUpsample(e,t){var n=this;return(0,f.Z)(function*(){const i=e.layer.tileInfo;yield n._populateElevationTiles(e,t);let l=!1;e.forEachTileToFetch((s,a)=>{i.upsampleTile(s)?l=!0:a()}),l&&(yield n._selectTilesAutoPrefetchUpsample(e,t))})()}_sampleGeometryWithElevation(e){e.geometry.coordinates.forEach(t=>{const n=t.elevationTile;let i=e.options.noDataValue;if(n){const l=n.sample(t.x,t.y);(0,y.pC)(l)?i=l:t.elevationTile=null}t.z=i})}_extractSampleInfo(e){const t=e.layer.tileInfo,n=(0,D.c9)(t.spatialReference);return e.geometry.coordinates.map(i=>{let l=-1;return i.elevationTile&&i.elevationTile!==e.outsideExtentTile&&(l=t.lodAt(i.elevationTile.tile.level).resolution*n),{demResolution:l}})}}class g{export(){return this._exporter(this.coordinates,this.spatialReference)}clone(e){const t=new g;return t.geometry=this.geometry,t.spatialReference=this.spatialReference,t.coordinates=e||this.coordinates.map(n=>this._cloneCoordinate(n)),t._exporter=this._exporter,t}project(e,t){var n=this;return(0,f.Z)(function*(){if(n.spatialReference.equals(e))return n.clone();yield(0,A.iQ)([{source:n.spatialReference,dest:e}],{signal:t});const i=new C.Z({spatialReference:n.spatialReference,points:n.coordinates.map(o=>[o.x,o.y])}),l=(0,A.iV)(i,e);if(!l)return null;const s=n.coordinates.map((o,r)=>{const u=n._cloneCoordinate(o),p=l.points[r];return u.x=p[0],u.y=p[1],u}),a=n.clone(s);return a.spatialReference=e,a})()}_cloneCoordinate(e){return{x:e.x,y:e.y,z:e.z,m:e.m,tile:null,elevationTile:null}}static fromGeometry(e){const t=new g;if(t.geometry=e,t.spatialReference=e.spatialReference,e instanceof g)t.coordinates=e.coordinates.map(n=>t._cloneCoordinate(n)),t._exporter=(n,i)=>{const l=e.clone(n);return l.spatialReference=i,l};else switch(e.type){case"point":{const n=e,{hasZ:i,hasM:l}=n;t.coordinates=i&&l?[{x:n.x,y:n.y,z:n.z,m:n.m}]:i?[{x:n.x,y:n.y,z:n.z}]:l?[{x:n.x,y:n.y,m:n.m}]:[{x:n.x,y:n.y}],t._exporter=(s,a)=>e.hasM?new q.Z(s[0].x,s[0].y,s[0].z,s[0].m,a):new q.Z(s[0].x,s[0].y,s[0].z,a);break}case"multipoint":{const n=e,{hasZ:i,hasM:l}=n;t.coordinates=n.points.map(i&&l?s=>({x:s[0],y:s[1],z:s[2],m:s[3]}):i?s=>({x:s[0],y:s[1],z:s[2]}):l?s=>({x:s[0],y:s[1],m:s[2]}):s=>({x:s[0],y:s[1]})),t._exporter=(s,a)=>e.hasM?new C.Z({points:s.map(o=>[o.x,o.y,o.z,o.m]),hasZ:!0,hasM:!0,spatiaReference:a}):new C.Z(s.map(o=>[o.x,o.y,o.z]),a);break}case"polyline":{const n=e,i=[],l=[],{hasZ:s,hasM:a}=e;let o=0;for(const r of n.paths)if(l.push([o,o+r.length]),o+=r.length,s&&a)for(const u of r)i.push({x:u[0],y:u[1],z:u[2],m:u[3]});else if(s)for(const u of r)i.push({x:u[0],y:u[1],z:u[2]});else if(a)for(const u of r)i.push({x:u[0],y:u[1],m:u[2]});else for(const u of r)i.push({x:u[0],y:u[1]});t.coordinates=i,t._exporter=(r,u)=>{const p=r.map(e.hasM?v=>[v.x,v.y,v.z,v.m]:v=>[v.x,v.y,v.z]),d=l.map(v=>p.slice(v[0],v[1]));return new X.Z({paths:d,hasM:e.hasM,hasZ:!0,spatialReference:u})};break}}return t}}class G{constructor(e,t){this.layer=e,this.options=t}}class re extends G{constructor(e,t,n){super(e,n),this.outSpatialReference=t,this.type="geometry"}selectTilesAtLOD(e){if(e<0)this.geometry.coordinates.forEach(t=>t.tile=null);else{const t=this.layer.tileInfo,n=t.lods[e].level;this.geometry.coordinates.forEach(i=>{i.tile=t.tileAt(n,i.x,i.y)})}}allElevationTilesFetched(){return!this.geometry.coordinates.some(e=>!e.elevationTile)}clearElevationTiles(){for(const e of this.geometry.coordinates)e.elevationTile!==this.outsideExtentTile&&(e.elevationTile=null)}populateElevationTiles(e){for(const t of this.geometry.coordinates)!t.elevationTile&&t.tile&&(t.elevationTile=e[t.tile.id])}remapTiles(e){for(const t of this.geometry.coordinates)t.tile=e[t.tile.id]}getTilesToFetch(){const e={},t=[];for(const n of this.geometry.coordinates){const i=n.tile;n.elevationTile||!n.tile||e[i.id]||(e[i.id]=i,t.push(i))}return t}forEachTileToFetch(e){for(const t of this.geometry.coordinates)t.tile&&!t.elevationTile&&e(t.tile,()=>t.tile=null)}}class ce extends G{constructor(e,t,n,i){super(e,n),this.type="extent",this.elevationTiles=[],this.candidateTiles=[],this.fetchedCandidates=new Set,this.extent=t.intersection(e.fullExtent),this.maskExtents=i}selectTilesAtLOD(e,t){const n=this._maximumLodForRequests(t),i=Math.min(n,e);i<0?this.candidateTiles.length=0:this._selectCandidateTilesCoveringExtentAt(i)}_maximumLodForRequests(e){const t=this.layer.tileInfo;if(!e)return t.lods.length-1;const n=this.extent;if((0,y.Wi)(n))return-1;for(let i=t.lods.length-1;i>=0;i--){const l=t.lods[i],a=l.resolution*t.size[1];if(Math.ceil(n.width/(l.resolution*t.size[0]))*Math.ceil(n.height/a)<=e)return i}return-1}allElevationTilesFetched(){return this.candidateTiles.length===this.elevationTiles.length}clearElevationTiles(){this.elevationTiles.length=0,this.fetchedCandidates.clear()}populateElevationTiles(e){for(const t of this.candidateTiles){const n=e[t.id];n&&(this.fetchedCandidates.add(t),this.elevationTiles.push(n))}}remapTiles(e){this.candidateTiles=this._uniqueNonOverlappingTiles(this.candidateTiles.map(t=>e[t.id]))}getTilesToFetch(){return this.candidateTiles}forEachTileToFetch(e,t){const n=this.candidateTiles;this.candidateTiles=[],n.forEach(i=>{if(this.fetchedCandidates.has(i))return void(t&&t(i));let l=!1;e(i,()=>l=!0),l?t&&t(i):this.candidateTiles.push(i)}),this.candidateTiles=this._uniqueNonOverlappingTiles(this.candidateTiles,t)}_uniqueNonOverlappingTiles(e,t){const n={},i=[];for(const s of e)n[s.id]?t&&t(s):(n[s.id]=s,i.push(s));const l=i.sort((s,a)=>s.level-a.level);return l.filter((s,a)=>{for(let o=0;o<a;o++)if((0,w.r3)(l[o].extent,s.extent))return t&&t(s),!1;return!0})}_selectCandidateTilesCoveringExtentAt(e){this.candidateTiles.length=0;const t=this.extent;if((0,y.Wi)(t))return;const n=this.layer.tileInfo,i=n.lods[e],l=n.tileAt(i.level,t.xmin,t.ymin),a=i.resolution*n.size[1],o=Math.ceil((t.xmax-l.extent[0])/(i.resolution*n.size[0])),r=Math.ceil((t.ymax-l.extent[1])/a);for(let u=0;u<r;u++)for(let p=0;p<o;p++){const d={id:null,level:l.level,row:l.row-u,col:l.col+p};n.updateTileInfo(d),this._tileIsMasked(d)||this.candidateTiles.push(d)}}_tileIsMasked(e){return!!this.maskExtents&&this.maskExtents.some(t=>(0,w.r3)(t,e.extent))}}function F(c,e){let t=c.lods.length-1;if(e>0){const n=c.lods.findIndex(i=>i.resolution<e);0===n?t=0:n>0&&(t=n-1)}return t}const I={maximumAutoTileRequests:20,noDataValue:0,returnSampleInfo:!1,demResolution:"auto",minDemResolution:0}}}]);