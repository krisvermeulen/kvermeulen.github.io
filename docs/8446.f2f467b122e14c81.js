"use strict";(self.webpackChunkangular_anb=self.webpackChunkangular_anb||[]).push([[8446],{98446:(me,B,t)=>{t.r(B),t.d(B,{default:()=>ce});var x=t(15861),r=t(17626),b=t(27e3),o=t(77712),V=(t(85931),t(8314),t(90912),t(76898)),W=t(62860),K=t(37384),T=t(88879),Q=t(84792),G=t(14517),O=t(63290),w=t(62208),D=t(10699),M=t(55342),j=t(2004),Y=t(28594),X=t(80355),$=t(51815),L=t(1011),q=t(36275),k=t(97291);const _=O.Z.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");let p=class extends G.Z{constructor(){var e;super(...arguments),e=this,this.attached=!1,this.container=new L.W,this.updateRequested=!1,this._graphicsView=null,this._projectFullExtentPromise=null,this._dataParameters={exportParametersVersion:0,extents:[],tileResolution:0,time:"",isOceanStyle:!1,isOceanographic:!1},this.type="Graphics",this._graphics=new $.J,this._updateGraphics=(0,D.Ds)(function(){var i=(0,x.Z)(function*(a,n){if(!a.stationary)return;const s=a.state,h=new j.Z({xmin:s.extent.xmin,ymin:s.extent.ymin,xmax:s.extent.xmax,ymax:s.extent.ymax,spatialReference:s.spatialReference}),[u,d]=a.state.size,c={};c.timeExtent=e.timeExtent,c.requestAsImageElement=!1,c.signal=n,null==e._projectFullExtentPromise&&(e._projectFullExtentPromise=e._getProjectedFullExtent(h.spatialReference));const y="vector-field"===e.layer.renderer.type?e.layer.renderer.symbolTileSize:50,v=yield e._projectFullExtentPromise,{extent:f,resolution:P,width:I,height:S}=(0,X.BH)(h,u,d,y,v),C=yield e.layer.fetchImage(f,I,S,c),g=e.layer.renderer;if("vector-field"===g.type){const R=C.pixelData.pixelBlock,E=g.sizeVariables[0];!(0,w.pC)(R)||E.minDataValue&&E.maxDataValue||(E.minDataValue=R.statistics[0].minValue,E.maxDataValue=R.statistics[0].maxValue),e._pixelData={extent:f,pixelBlock:R};const z=f.clone().normalize(),H={exportParametersVersion:e.layer.exportImageServiceParameters.version,extents:z,tileResolution:P,time:JSON.stringify(e.timeExtent||""),isOceanStyle:"flow-to"===g.flowRepresentation,isOceanographic:"ocean-current-kn"===g.style||"ocean-current-m"===g.style},U=e._canReuseVectorFieldData(H)?e._dataParameters.extents:[],A=yield g.getGraphicsFromPixelData(C.pixelData,"vector-uv"===e.layer.rasterInfo.dataType,U);if(U.length){const ye=e._graphics.items.filter(Z=>(0,w.pC)(Z.geometry)&&U.some(F=>F.intersects(Z.geometry))&&!z.some(F=>F.intersects(Z.geometry)));e._graphics.removeMany(ye),e._graphics.addMany(A)}else e._graphics.set("items",A);e._graphicsView.update(a),e._dataParameters=H}});return function(a,n){return i.apply(this,arguments)}}())}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(e){this._updateGraphics(e).catch(i=>{(0,D.D_)(i)||_.error(i)})}hitTest(e){return new T.Z({attributes:{},geometry:e.clone(),layer:this.layer})}attach(){this._graphicsView=new k.Z({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new q.Z(this.view.featuresTilingScheme)}),this.attached=!0}detach(){this._graphics.destroy(),this._graphicsView.destroy(),this.container.removeChild(this._graphicsView.container),this._graphicsView=null}install(e){this.container.addChild(this._graphicsView.container),e.addChild(this.container)}uninstall(e){this.container.removeChild(this._graphicsView.container),e.removeChild(this.container)}isUpdating(){return this._graphicsView.updating||this.updateRequested}getPixelData(){return this.updating?null:this._pixelData}redraw(){}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}_getProjectedFullExtent(e){var i=this;return(0,x.Z)(function*(){try{return yield(0,Y.tB)(i.layer.fullExtent,e)}catch(a){try{const n=(yield(0,Q.default)(i.layer.url,{query:{option:"footprints",outSR:e.wkid||JSON.stringify(e.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return n?j.Z.fromJSON(n):null}catch(n){return null}}})()}_canReuseVectorFieldData(e){const i=this._dataParameters.exportParametersVersion===e.exportParametersVersion,a=this._dataParameters.time===e.time,n=Math.abs(this._dataParameters.tileResolution-e.tileResolution)/e.tileResolution<.01,s=this._dataParameters.extents.some(d=>e.extents.some(c=>d.intersects(c)));return i&&a&&n&&s&&this._dataParameters.isOceanStyle===e.isOceanStyle&&this._dataParameters.isOceanographic===e.isOceanographic}};(0,r._)([(0,o.Cb)()],p.prototype,"attached",void 0),(0,r._)([(0,o.Cb)()],p.prototype,"container",void 0),(0,r._)([(0,o.Cb)()],p.prototype,"layer",void 0),(0,r._)([(0,o.Cb)()],p.prototype,"timeExtent",void 0),(0,r._)([(0,o.Cb)()],p.prototype,"view",void 0),(0,r._)([(0,o.Cb)()],p.prototype,"updateRequested",void 0),(0,r._)([(0,o.Cb)()],p.prototype,"updating",null),(0,r._)([(0,M.J)({graphics:"Graphics"})],p.prototype,"type",void 0),p=(0,r._)([(0,V.j)("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],p);const ee=p;var te=t(77692),ie=t(91757),ae=t(14403),se=t(67802);const re=O.Z.getLogger("esri.views.2d.layers.imagery.ImageryView2D");let l=class extends G.Z{constructor(){super(...arguments),this.attached=!1,this.container=new L.W,this.updateRequested=!1,this.type="Imagery",this._bitmapView=null}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(e){this.strategy.update(e).catch(i=>{(0,D.D_)(i)||re.error(i)})}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren()}hitTest(e){return new T.Z({attributes:{},geometry:e.clone(),layer:this.layer})}attach(){const e=this.layer.version>=10,i=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,a=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this._bitmapView=new ie.c,this.strategy=new se.Z({container:this._bitmapView,imageNormalizationSupported:e,imageMaxHeight:i,imageMaxWidth:a,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()}),this.attached=!0}install(e){this.container.addChild(this._bitmapView),e.addChild(this.container)}uninstall(e){this.container.removeChild(this._bitmapView),e.removeChild(this.container)}redraw(){this.strategy.updateExports(e=>{e.source instanceof HTMLImageElement?e.requestRender():this.layer.applyRenderer({pixelBlock:e.source.pixelBlock}).then(i=>{const a=e.source;a.pixelBlock=i.pixelBlock,a.filter=n=>this.layer.applyFilter(n),this.container.requestRender()})})}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;const e=this.strategy.bitmaps;if(1===e.length&&e[0].source)return{extent:e[0].source.extent,pixelBlock:e[0].source.originalPixelBlock};if(e.length>1){const i=this.view.extent,a=e.map(s=>s.source).filter(s=>s.extent&&s.extent.intersects(i)).map(s=>({extent:s.extent,pixelBlock:s.originalPixelBlock})),n=(0,te.Kh)(a,i);return(0,w.pC)(n)?{extent:n.extent,pixelBlock:n.pixelBlock}:null}return null}_fetchImage(e,i,a,n){return(n=n||{}).timeExtent=this.timeExtent,n.requestAsImageElement=!0,this.layer.fetchImage(e,i,a,n).then(s=>s.imageElement?s.imageElement:this.layer.applyRenderer(s.pixelData,{signal:n.signal}).then(h=>{const u=new ae.Z(h.pixelBlock,h.extent.clone(),s.pixelData.pixelBlock);return u.filter=d=>this.layer.applyFilter(d),u}))}};(0,r._)([(0,o.Cb)()],l.prototype,"attached",void 0),(0,r._)([(0,o.Cb)()],l.prototype,"container",void 0),(0,r._)([(0,o.Cb)()],l.prototype,"layer",void 0),(0,r._)([(0,o.Cb)()],l.prototype,"strategy",void 0),(0,r._)([(0,o.Cb)()],l.prototype,"timeExtent",void 0),(0,r._)([(0,o.Cb)()],l.prototype,"view",void 0),(0,r._)([(0,o.Cb)()],l.prototype,"updateRequested",void 0),(0,r._)([(0,o.Cb)()],l.prototype,"updating",null),(0,r._)([(0,M.J)({imagery:"Imagery"})],l.prototype,"type",void 0),l=(0,r._)([(0,V.j)("esri.views.2d.layers.imagery.ImageryView2D")],l);const ne=l;var J=t(26584),N=t(49672),oe=t(13812),le=t(84952),he=t(10023);const pe=e=>{let i=class extends e{constructor(){super(...arguments),this.view=null}fetchPopupFeatures(a,n){var s=this;return(0,x.Z)(function*(){const{layer:h}=s;if(!a)throw new J.Z("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:h});const{popupEnabled:u}=h,d=(0,he.V)(h,n);if(!u||!(0,w.pC)(d))throw new J.Z("imagerylayerview:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:u,popupTemplate:d});const c=yield d.getRequiredFields(),y=new le.Z;y.timeExtent=s.timeExtent,y.geometry=a,y.outFields=c,y.outSpatialReference=a.spatialReference;const v=s.view.resolution,f="2d"===s.view.type?new N.Z(v,v,s.view.spatialReference):new N.Z(.5*v,.5*v,s.view.spatialReference),{returnTopmostRaster:P,showNoDataRecords:I}=d.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},S={returnDomainValues:!0,returnTopmostRaster:P,pixelSize:f,showNoDataRecords:I,signal:(0,w.pC)(n)?n.signal:null};return h.queryVisibleRasters(y,S).then(C=>C)})()}canResume(){var a;return!(!super.canResume()||null!=(a=this.timeExtent)&&a.isEmpty)}};return(0,r._)([(0,o.Cb)()],i.prototype,"layer",void 0),(0,r._)([(0,o.Cb)()],i.prototype,"suspended",void 0),(0,r._)([(0,o.Cb)(oe.qG)],i.prototype,"timeExtent",void 0),(0,r._)([(0,o.Cb)()],i.prototype,"view",void 0),i=(0,r._)([(0,V.j)("esri.views.layers.ImageryLayerView")],i),i};var de=t(45611),ue=t(94421);let m=class extends(pe((0,ue.y)((0,K.y)(de.Z)))){constructor(){super(...arguments),this._exportImageVersion=-1}initialize(){this.handles.add([(0,b.S1)(this,["layer.blendMode","layer.effects"],e=>{this.subview&&(this.subview.container.blendMode=e)},!0),(0,b.S1)(this,"layer.effect",e=>{this.subview&&(this.subview.container.effect=e)},!0)])}get pixelData(){return this.updating?null:"getPixelData"in this.subview?this.subview.getPixelData():null}get updating(){return!!(!this.subview||"updating"in this.subview&&this.subview.updating)}hitTest(e,i){var a=this;return(0,x.Z)(function*(){return a.subview?"hitTest"in a.subview?[a.subview.hitTest(e)]:[]:null})()}update(e){var i;null==(i=this.subview)||i.update(e)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.handles.add([(0,b.S1)(this,"layer.exportImageServiceParameters.version",e=>{this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())}),this.watch("timeExtent",()=>{"timeExtent"in this.subview&&(this.subview.timeExtent=this.timeExtent),this.requestUpdate()}),this.layer.on("redraw",()=>{"redraw"in this.subview?this.subview.redraw():this.subview.redrawOrRefetch()}),(0,b.YP)(this.layer,"renderer",()=>this._setSubView())],"imagerylayerview-update")}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.subview.destroy(),this.handles.remove("imagerylayerview-update"),this._exportImageVersion=-1}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}doRefresh(){var e=this;return(0,x.Z)(function*(){e.requestUpdate()})()}isUpdating(){return!this.subview||!this.suspended&&this.subview.updating}_setSubView(){var e,i;let a="Imagery";var n,s;"vector-field"===(null==(e=this.layer.renderer)?void 0:e.type)&&"lerc"===this.layer.format&&(a="Graphics"),"animated-flow"===(null==(i=this.layer.renderer)?void 0:i.type)&&(a="Flow"),this.subview&&this.subview.type===a||(null==(n=this.subview)||n.uninstall(this.container),null==(s=this.subview)||s.destroy(),this.subview="Imagery"===a?new ne({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):"Graphics"===a?new ee({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new W.Z({layer:this.layer,layerView:this}),this.subview.attach(),this.subview.install(this.container),this.subview.container.blendMode=this.layer.blendMode,this.subview.container.effect=this.layer.effect),this.requestUpdate()}};(0,r._)([(0,o.Cb)()],m.prototype,"pixelData",null),(0,r._)([(0,o.Cb)({readOnly:!0})],m.prototype,"updating",null),(0,r._)([(0,o.Cb)()],m.prototype,"subview",void 0),m=(0,r._)([(0,V.j)("esri.views.2d.layers.ImageryLayerView2D")],m);const ce=m}}]);